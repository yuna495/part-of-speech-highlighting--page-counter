# Change Log

All notable changes to this extension are documented here.

## [2.2.5] - 2025/10/13

### 追加

- **見出しごとの文字数表示を強化**
  - 見出し行の末尾に「- 〇字 / □字」を表示。
    - **〇字**：当該見出しの本文（次の任意レベルの見出し直前まで）の文字数。
    - **□字**：当該見出しおよび配下の全見出し群（子孫すべて）の本文文字数合計。
  - 〇字・□字がそれぞれ 0 の場合は非表示。
  - 〇＝□ の場合（下位見出しを持たない場合）は「/ □字」を省略。
  - `.txt` / `.md` / `Novel` すべてに対応。
  - 設定 `posNote.headings.showBodyCounts` により ON/OFF 切り替え可能（デフォルト: ON）。
  - 計算方法はステータスバーの総文字数と同一。

## [2.2.4] - 2025/10/11

### 修正

- .txtにおいて、見出しをパンくずリストとして、見出し階層を辿れるように修正。
- サイドパネルの見出しレベルごとの字下げを「　」から「 」に変更。
- 文字色ハイライトの適応順序調整。

## [2.2.3] - 2025/09/29

### 修正

- 縦書きプレビュー画面の修正。
  - ルビ、傍点の表示。[三点リーダー2つ]セット「……」を行の中央に全角2文字分（4つセットに）。
  - コードフェンスによるコメントをプレビューにおいても同色ハイライト。
- READMEの画像追加、内部リンク実装

## [2.2.2] - 2025-09-27

### 追加

- **合算文字数表示の改善**
  - 編集中ファイルを含めて、同フォルダ内・同拡張子ファイルの合算文字数をステータスバーに表示。
  - 設定 `posNote.aggregate.showFolderSum` で ON/OFF 切り替え可能。
  - 見出し行（# で始まる行）は「未選択時」「選択時」「合算」のいずれでも文字数に含めないよう統一。

- **ルビ／傍点挿入ショートカット**
  - `Ctrl + Alt + R`: 選択文字列に **ルビ** を付与 → `|選択《》`（キャレットは《》内）。
  - `Ctrl + Alt + B`: 選択文字列に **傍点** を付与 → `|字《・》|字《・》…`。
  - 選択がない場合もカーソル位置に雛形を挿入。

### 変更

- サイドバーに表示される見出しレベルアイコンを緑のローマ数字に変更。

## [2.2.1] - 2025-09-24

### 追加

- **コードフェンスコメント機能**

  - ```改行```で囲まれた複数行を「コメント」として扱い、手動で折りたたみ可能に。
  - フェンス内部はハイライト対象外となり、既定では `#f0f0c0` の単色で表示。

  - コメント色は `editor.semanticTokenColorCustomizations.rules.fencecomment` で任意に変更可能。
  - 見出しの一括折りたたみ／展開（Ctrl+[）の対象外とし、手動折りたたみは残す仕様。
  - 文字数・ページ/行計算からは除外。

### 修正

- 《》で囲まれたルビを文字数としてカウントしない。ページ/行計算からも除外。

## [2.2.0] - 2025-09-11

### 追加

- **フォルダ内ファイル結合コマンド**
  - エクスプローラーでフォルダを右クリックし、以下のメニューを利用可能に:
    - `POS/Note: フォルダ内の .txt を結合`
    - `POS/Note: フォルダ内の .md を結合`
  - 選択フォルダ直下にある `.txt` / `.md` ファイルを**ファイル名昇順**で結合し、同フォルダ直下に `combined.txt` / `combined.md` を出力
  - 出力ファイルが既に存在する場合は `(1)`, `(2)` … のようにリネームして保存
  - ファイル間には空行1行を挿入、改行コードは `\n` に統一
  - 実行後、自動的に生成ファイルを開く

### 変更

- displayNameを「POS & Note (小説・論文執筆アシスト)」に変更。
- 説明文に「小説執筆向け」を追加。
- 文字数カウントについて、全角スペースに追加して、見出し指定の「#」をカウントしないように設定。

## [2.1.0] - 2025-09-10

### 追加

- **ユーザー辞書ハイライト（同フォルダ限定・最優先）**
  - 編集中ドキュメントと**同じフォルダ**にある `characters.json` / `glossary.json` を読み込み、該当語を **semantic token: `character` / `glossary`** として**最優先**で着色
  - **プレビューにも同じ規則を適用**（`toPosHtml` に `docUri` を渡し、エディタと同一ロジックで `<span class="pos-character/glossary">` を生成）

### 挙動

- **同フォルダに辞書が無い場合は一切適用しない**
- **優先順位**：辞書語 ＞ 括弧上書き（`bracket`） ＞ 品詞（名詞/動詞…）
- **形式**：
  - 文字列配列：`["奏音","未澪"]`
  - オブジェクト配列：`[{ "name": "奏音", "alias": ["かなで"] }]` / `[{ "term": "祠", "variants": ["社"] }]`
  - 連想形式：`{ "奏音": { "alias": ["かなで"] }, "未澪": "説明" }`

### 設定

- 色は VS Code の `editor.semanticTokenColorCustomizations.rules` で変更可能  
  例）`"character": "#ff14e0"`, `"glossary": "#ff0000"`
- 既存の品詞色設定と共存（辞書色が重なり領域をマスク）

### パフォーマンス

- 行内は**最長一致＋非重複**でマッチ。語数が非常に多い場合は読み込みコスト増のため、章ごとに辞書を分割推奨

### 互換性

- 破壊的変更なし。`2.0.x` からの移行で追加設定は不要

## [2.0.1] - 2025-09-09

- 変更
  - **括弧補完の実装を VS Code の Language Configuration に委譲**  
    `setLanguageConfiguration` の `autoClosingPairs / surroundingPairs / brackets` を利用し、開き入力→閉じ自動補完＋キャレット内側移動をエディタ側で処理。入力時の再入制御・余計な `edit` 呼び出しを撤去し、体感遅延を軽減。
  - **Backspace 同時削除を軽量化**  
    `_caretCacheByUri` による「カーソル前後1文字キャッシュ」で O(1) 判定。全文スナップショット `_prevTextByUri` を廃止。`TextEditor.edit()` の戻り（Thenable）に対しては `.finally` ではなく `then(success, failure)` で再入フラグを確実に解除。

- 内部整理
  - **ファイル分割**：`bracket.js`（括弧補完・Backspace 同時削除）、`headline.js`（見出しトグル／FoldingRangeProvider／可視範囲追随）。`extension.js` は初期化・司令塔に専念。
  - **イベント購読の一本化**：見出しの可視範囲変更ハンドラ（`onDidChangeTextEditorVisibleRanges`）を `headline.js` 側へ移管し、二重発火を解消。
  - **重複の除去**：`PreviewPanel` の再 `require` と `const cp` 再宣言（TS2451）を解消。未使用の import／旧関数／不要設定キーを削除。
  - **型まわりの安定化**：Thenable への `.finally` 使用を撤去（TS2339回避）、オプション引数の JSDoc を `?` 指定にして TS2739 を回避。

- 互換性
  - 破壊的変更なし（設定キーの追加・削除なし）。既存プロジェクトでそのまま更新可能。

## [2.0.0] - 2025-09-01

- 追加
  - **プレビュー機能**
    - エディタ右上の 📖 アイコンから縦書きプレビューを開けるように
    - プレビュー内の行クリックでエディタにジャンプ、エディタ側で選択した行はプレビューでハイライトされる（双方向同期）
    - プレビュー内でも品詞ハイライトを適用可能
    - プレビューの描画・品詞ハイライトはエディタ保存時に反映される
    - 品詞着色は「選択行を中心に ±`maxLines` 行」のみを解析対象とする動的モードに変更（既定: 1000 行）

## [1.3.6] - 2025-08-27

- 修正
  - **見出しハイライト**
    - "posNote.semantic.enabledMd"ON時に「.md」ファイルに適用されていなかった問題を修正
  - **README**
    - 品詞ハイライト設定例追記

## [1.3.5] - 2025-08-27

- 追加
  - **括弧内ハイライトのトグル設定**
    - 設定キー `posNote.semantic.bracketsOverride.enabled` を追加
    - ON（デフォルト）: 括弧と括弧内を専用色で塗り、括弧内は品詞ハイライトを抑制
    - OFF: 括弧内も通常の品詞ハイライトを適用

- 改善
  - **内部コード整理**
    - セマンティックトークン関連を `semantic.js` に分割
    - ステータスバー関連を `status_bar.js` に移動
    - 共通関数 `getHeadingLevel` を `utils.js` に切り出し

## [1.3.4] - 2025-08-24

- 追加
  - **ミニマップ見出しハイライト**
    - 「#」「##」などの見出し行をミニマップ上に強調表示
    - レベルごとに異なる色で表示されるように改善
    - ファイル保存時に自動で更新される
    - `.txt` / `.md` / `Novel` で動作

- 修正
  - アクティビティバーの見出しレベルアイコンを微調整

## [1.3.3] - 2025-08-24

- 見出しビュー
  - アクティビティバーに「#」「##」などの見出しを自動抽出し、一覧表示（Bookmarksのような機能）
  - 見出しをクリックすると該当行にジャンプ
  - ファイル保存時に自動更新

## [1.3.2] - 2025-08-22

- 追加
  - ステータスバーの文字数カウントに関するオプションを追加
    - **見出し行（# / ##）を総文字数に含めない**
    - **スペース（半角・全角）を総文字数＆選択文字数に含めるかどうかの設定**（デフォルト: 含めない）
- 修正
  - 内部処理を整理し、不要な関数を削除

## [1.3.1] - 2025/08/22

- Readmeの画像リンクを正しました。

## [1.3.0] - 2025-08-21

- 追加
  - **見出し折りたたみ制御**
    - 「#」で第一見出し、「##」で第二見出し（マークダウン記法と同様）
    - `Ctrl + [` による展開/折りたたみ
    - 一つでも見出しが展開され、変更されていれば「全折りたたみ」に切り替え、それ以外では「全展開」を実行
  - 見出しの一括折りたたみにおいて、**折りたたむ最小レベル**を指定できる設定を追加  
    - `posNote.headings.foldMinLevel`（既定: **2**）  
    - 例）2 → `##` 以上を一括折りたたみ、3 → `###` 以上を一括折りたたみ

- 修正
  - 内部コード整理（未使用変数・未使用関数を削除）
  - eslint 警告をすべて解消
  - 設定項目から行頭禁則文字を削除。
    - setting.jsonにて設定可
  - ステータスバー関連の関数を`status_bar.js`に分割

## [1.2.1] - 2025-08-21

- 追加
  - 行末の禁則文字追加
  - **全角括弧の入力支援**
    - 「『（［｛〈《【〔 ‘ “の**開き入力で自動閉じを補完**（常時ON）
    - **ネスト対応**：内側の開き入力でも外側の閉じが消えず、`「『』」` のように正しく構築
    - **IME変換追従**：開き確定後に「→『」等へ変換すると、直後の閉じも `」→』` に自動置換
    - **Backspace 連動**：開きを削除した際、直後が対応する閉じなら自動で同時削除
  - **括弧ハイライトの統一（semantic token）**
    - **改行またぎ＆ネスト**対応で、開き→次の対応閉じまでを一括で `bracket` として色付け
    - これに伴い、旧 Decoration ベースの括弧ハイライトは撤去（処理の二重化を解消）
    - 既定色は `editor.semanticTokenColorCustomizations.rules.bracket: "#fd9bcc"`

- 変更
  - **セマンティックの堅牢化**：辞書（kuromoji）が未ロードでも、括弧/全角スペース/ダッシュはハイライト継続（品詞は辞書があるときのみ）
  - **内部整理**：未使用設定/コードの削除、関数の並び順を再配置
  - **型エラー解消**：`PromiseLike` に対する `.finally()` を排除し、`then(success, failure)` に統一

- 互換性
  - 破壊的変更なし（設定キーの追加・削除なし）

## [1.2.0]

- ステータスバー表示を強化
  - `現在ページ/総ページ-行（行×列）字（編集中のファイルと同一フォルダ内、同一拡張子の総文字数）` の形式に変更
  - 合算文字数は同一フォルダ内の `.txt` または `.md` を対象とし、ファイル保存時に再計算
  - 設定 `posNote.aggregate.showCombinedChars` で ON/OFF を切り替え可能
- README の機能を更新

## [1.1.0]

- `.md` ファイルを新たに解析対象に追加
- 他拡張「NOVEL-WRITER」による言語モード `Novel` に対応
  - 「NOVEL-WRITER」かこちらのどちらかの品詞ハイライトをOFFにして下さい。
- 品詞ハイライトの有効/無効を `posNote.semantic.enabled` に統合
  - 旧オプション `posNote.enabledPos` とコマンド `posNote.togglePos` を削除
- 既定値を `rowsPerNote=20` / `colsPerRow=20` に統一
- `.md` ファイルの品詞ハイライトを独立して ON/OFF できる設定項目を追加
  - `posNote.semantic.enabledMd`（デフォルト: true）
  - `.txt` / `Novel` 用の `posNote.semantic.enabled` とは別に制御可能
- README の設定例を拡充（全品詞トークンのサンプルを記載）
- README を更新し、新オプションの説明を追加

## [1.0.1]

- デコレーション方式を semantic token に統一
  - 括弧と中身、記号（—、、。）を `bracket` / `symbol` としてハイライト可能に
  - 全角スペースは下線方式の semantic token で表示
- ステータスバー更新処理を改善（入力時のカクつきを軽減）
- 不要な旧デコ関数や設定を削除し、コードを整理

## [1.0.0]

- 初期リリース
  - 品詞カラー表示（kuromoji）
  - ページカウンタ（行×列・禁則処理対応）
  - ステータスバーで選択文字数表示
